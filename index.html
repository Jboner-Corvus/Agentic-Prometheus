<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic-MCP Interface</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .message-content pre, .message-content code {
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .thinking-indicator::after {
            content: '.';
            animation: dots 1.4s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: white;
                text-shadow:
                    .25em 0 0 rgba(0,0,0,0),
                    .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow:
                    .25em 0 0 white,
                    .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow:
                    .25em 0 0 white,
                    .5em 0 0 white;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration (à adapter si nécessaire)
        const API_URL = '/api/v1/agent/stream'; // Utilise un proxy, ou mettez l'URL complète http://localhost:8080/api/v1/agent/stream
        const AUTH_TOKEN = "change-me-to-a-very-strong-and-random-secret-token"; // Doit correspondre au .env du serveur

        // Composant principal de l'application
        const App = () => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [status, setStatus] = useState({ state: 'idle', message: 'En attente...' });
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', content: input };
                setMessages(prev => [...prev, userMessage]);
                setIsLoading(true);
                setStatus({ state: 'thinking', message: 'Réflexion en cours' });
                setInput('');

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AUTH_TOKEN}`,
                        },
                        body: JSON.stringify({ goal: input }),
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur HTTP: ${response.status} - ${errorText}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    let assistantMessage = { role: 'assistant', thoughts: [], toolCalls: [], finalAnswer: null };

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const chunks = buffer.split('\n\n');
                        buffer = chunks.pop(); // Garde le dernier chunk incomplet

                        for (const chunk of chunks) {
                            if (chunk.startsWith('data: ')) {
                                try {
                                    const jsonData = JSON.parse(chunk.substring(6));
                                    
                                    if(jsonData.type === 'thought') {
                                        assistantMessage.thoughts.push(jsonData.content);
                                        setStatus({ state: 'thinking', message: 'Réflexion...' });
                                    } else if (jsonData.type === 'tool_call') {
                                         assistantMessage.toolCalls.push({ name: jsonData.tool, params: jsonData.parameters, output: null });
                                         setStatus({ state: 'executing', message: `Utilisation de l'outil: ${jsonData.tool}` });
                                    } else if (jsonData.type === 'tool_output') {
                                        const lastToolCall = assistantMessage.toolCalls[assistantMessage.toolCalls.length - 1];
                                        if(lastToolCall) lastToolCall.output = jsonData.content;
                                        setStatus({ state: 'thinking', message: 'Analyse du résultat...' });
                                    } else if (jsonData.type === 'final_answer') {
                                        assistantMessage.finalAnswer = jsonData.content;
                                        setStatus({ state: 'finished', message: 'Terminé!' });
                                    }
                                    
                                    setMessages(prev => {
                                        const newMessages = [...prev];
                                        if (newMessages[newMessages.length - 1].role === 'assistant') {
                                            newMessages[newMessages.length - 1] = { ...assistantMessage };
                                        } else {
                                            newMessages.push({ ...assistantMessage });
                                        }
                                        return newMessages;
                                    });

                                } catch (e) {
                                    console.warn('Erreur de parsing JSON du stream:', e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error("Erreur de fetch:", error);
                    setMessages(prev => [...prev, { role: 'system', content: `Erreur: ${error.message}` }]);
                    setStatus({ state: 'error', message: 'Erreur de connexion' });
                } finally {
                    setIsLoading(false);
                    setStatus({ state: 'idle', message: 'En attente...' });
                }
            };

            return (
                <div className="flex flex-col h-screen bg-gray-800">
                    <header className="bg-gray-900 p-4 border-b border-gray-700 shadow-md">
                        <h1 className="text-xl font-bold text-center text-gray-200">Agentic-MCP Interface</h1>
                    </header>
                    <main className="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
                        {messages.map((msg, index) => <Message key={index} message={msg} />)}
                        <div ref={messagesEndRef} />
                    </main>
                    <footer className="p-4 bg-gray-900 border-t border-gray-700">
                        <div className="flex items-center text-sm text-gray-400 mb-2 px-2">
                            {isLoading ? <Spinner /> : <i className="fas fa-check-circle text-green-500 mr-2"></i>}
                            <span className={isLoading ? 'thinking-indicator' : ''}>{status.message}</span>
                        </div>
                        <form onSubmit={handleSubmit} className="flex items-center bg-gray-800 rounded-lg p-2 border border-gray-600 focus-within:border-cyan-500">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="Entrez votre objectif..."
                                className="flex-1 bg-transparent focus:outline-none px-2 text-gray-200"
                                disabled={isLoading}
                            />
                            <button type="submit" disabled={isLoading} className="bg-cyan-600 hover:bg-cyan-700 disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                                <i className="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </footer>
                </div>
            );
        };

        const Spinner = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        const Message = ({ message }) => {
            const getIcon = (role) => {
                switch (role) {
                    case 'user': return 'fa-user-astronaut';
                    case 'assistant': return 'fa-robot';
                    case 'system': return 'fa-exclamation-triangle';
                    default: return 'fa-question-circle';
                }
            };

            const getBgColor = (role) => {
                switch (role) {
                    case 'user': return 'bg-gray-700';
                    case 'assistant': return 'bg-gray-800';
                    case 'system': return 'bg-red-900/50';
                    default: return 'bg-gray-600';
                }
            }

            if (message.role === 'assistant') {
                return (
                     <div className={`flex items-start space-x-4 p-4 rounded-lg ${getBgColor(message.role)}`}>
                        <i className={`fas ${getIcon(message.role)} text-cyan-400 text-xl mt-1`}></i>
                        <div className="flex-1 message-content">
                            {message.thoughts.map((thought, i) => (
                                <details key={i} className="mb-2 bg-gray-900/50 p-3 rounded-md">
                                    <summary className="cursor-pointer text-sm text-gray-400 font-semibold"><i className="fas fa-lightbulb mr-2 text-yellow-400"></i>Pensée de l'agent</summary>
                                    <pre className="text-gray-300 mt-2 text-sm whitespace-pre-wrap">{thought}</pre>
                                </details>
                            ))}
                            {message.toolCalls.map((call, i) => (
                                <div key={i} className="mb-2 bg-gray-900/50 p-3 rounded-md">
                                    <p className="text-sm font-semibold text-cyan-300"><i className="fas fa-cogs mr-2"></i>Appel d'outil: <code className="font-bold">{call.name}</code></p>
                                    <details className="mt-2">
                                        <summary className="cursor-pointer text-xs text-gray-400">Voir les paramètres</summary>
                                        <pre className="bg-gray-900 p-2 rounded mt-1 text-xs">{JSON.stringify(call.params, null, 2)}</pre>
                                    </details>
                                    {call.output && (
                                        <div className="mt-2">
                                             <p className="text-sm font-semibold text-green-400"><i className="fas fa-check-double mr-2"></i>Résultat de l'outil:</p>
                                             <pre className="bg-gray-900 p-2 rounded mt-1 text-sm whitespace-pre-wrap">{call.output}</pre>
                                        </div>
                                    )}
                                </div>
                            ))}
                             {message.finalAnswer && (
                                <div className="mt-4 p-3 bg-green-900/30 rounded-md border-l-4 border-green-500">
                                    <p className="font-bold text-green-300"><i className="fas fa-flag-checkered mr-2"></i>Réponse Finale</p>
                                    <p className="text-gray-200 mt-2">{message.finalAnswer}</p>
                                </div>
                            )}
                        </div>
                    </div>
                )
            }

            return (
                <div className={`flex items-start space-x-4 p-4 rounded-lg ${getBgColor(message.role)}`}>
                    <i className={`fas ${getIcon(message.role)} text-cyan-400 text-xl mt-1`}></i>
                    <div className="flex-1 message-content">
                        <pre>{message.content}</pre>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
